name: Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  import-test:
    name: Import and Schema Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        df -h

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-cu124-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-cu124-

    - name: Install PyTorch with CUDA
      run: |
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124

    - name: Install base dependencies
      run: |
        pip install pytest pytest-timeout pyyaml trimesh numpy scipy
        pip install addict omegaconf huggingface-hub
        pip install -r requirements.txt

    - name: Install CUDA-specific packages
      run: |
        python install.py

    - name: Run import tests
      run: |
        pytest tests/test_imports.py -v

  cuda-installation-test:
    name: CUDA Installation Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        df -h

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-cu124-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-cu124-

    - name: Install PyTorch with CUDA
      run: |
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124

    - name: Install requirements
      run: |
        pip install -r requirements.txt

    - name: Run install.py
      run: |
        python install.py

    - name: Verify CUDA packages installed
      run: |
        python -c "import torch; print(f'PyTorch: {torch.__version__}')"
        python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
        python -c "import spconv; print('spconv imported successfully')"
        python -c "import torch_scatter; print('torch-scatter imported successfully')"
        python -c "import torch_cluster; print('torch-cluster imported successfully')"

    - name: Test node imports with CUDA packages
      run: |
        pytest tests/test_imports.py -v

  cpu-smoke-test:
    name: CPU Integration Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install PyTorch (CPU)
      run: |
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu

    - name: Install all dependencies
      run: |
        pip install -r requirements.txt

    - name: Cache HuggingFace models
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: hf-models-${{ hashFiles('nodes/core/config/infer.yaml') }}

    - name: Run CPU smoke test
      timeout-minutes: 25
      run: |
        pytest tests/integration/test_workflows.py::test_p3sam_segmentation_only -v -s --tb=short
      env:
        PYTORCH_CUDA_ALLOC_CONF: max_split_size_mb:512
